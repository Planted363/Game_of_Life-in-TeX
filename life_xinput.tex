%% ## Parsing RLE-format encoded patterns (experimental). ##
%% Catcode changes (# and $ denote info-lines and pattern-EOLs respectively).
\catcode`\#=\active \catcode`\$=\active \catcode`\+=6\relax

\def^^d{\endgraf}

% Avoids tokenization.
\def\gameinput{\lb@setup\catcode`\#=\active\catcode`\$=\active\catcode`\^^M=\active\activatedigits\stringdigits\@gameinput}
\def\@gameinput+1{+1\catcode`\^^M=5\relax}

%% ## Header Parsing. ##
%% Every newline matters, proceed with caution.
\catcode`\^^M=\active\relax%
\def^^M{\futurelet\next\l@input@header@parse@}%
%% Detects header line.
\def\l@input@header@parse@{%
    \ifx\next x%
        \expandafter\l@input@header%
    \fi%
}%
%% Scans for header directives. Returns EOL to its usual catcode. Starts the body processing.
\def\l@input@header+1^^M{\l@input@header@parse+1, @END, \let^^M\empty\l@input@body@parse}%
\def\l@input@header@parse@end{@END}%
%% Spaces matter.
\def\l@input@header@parse+1, {%
    \def\next{+1}%
    \ifx\l@input@header@parse@end\next%
        \let\next\relax%
    \else%
        \l@input@attrib+1;%
        \let\next\l@input@header@parse%
    \fi\next%
}%
%% Sets attributes for the run.
%% Spaces matter (again).
\def\l@input@attrib+1 = +2;{\expandafter\def\csname l@attrib@+1\endcsname{+2}}%
%% Is it a title? Is it a comment (description)? Do nothing otherwise.
\long\def#+1 +2^^M{%
    \ifnum\uccode`N=\uccode`+1\relax%
        \def\l@attrib@name{+2}%
        \else%
            \ifnum\uccode`C=\uccode`+1\relax%
            %% Append to description.
            \edef\l@attrib@name{\l@attrib@name\ +2}
        \fi%
    \fi%
^^M}%
%
\catcode`\^^M=5

%% ## Body Parsing. ##
\def\l@input@body@parse+1!{\begingroup\activatedigits+1\endgroup}

\def\dodigits{\do0\do1\do2\do3\do4\do5\do6\do7\do8\do9}

\def\disable+1{\catcode`+1=12\relax}
\def\activate+1{\catcode`+1=\active}

\def\disabledigits{\let\do\disable \dodigits}%
\def\activatedigits{\let\do\activate \dodigits}%

%% Assign definitions to active digit characters.
\def\l@input@body@parse@setup@+1{%
    \begingroup
        \lccode`\~=`+1\relax
    \lowercase{\endgroup\def~}{\disabledigits\afterassignment\l@input@body@parse@repeat\h=+1}
}
\def\l@input@body@parse@setup{\let\do\l@input@body@parse@setup@ \dodigits}

%% Here we write \aftergroup+1 instead of saving the argument first because it is automatically assumed to be a single token.
\def\l@input@body@parse@repeat+1{%
    \begingroup\aftergroup\def\aftergroup\next\aftergroup{%
    \loop\aftergroup+1\advance\p1\ifnum\p<\h\repeat\aftergroup}\aftergroup\next
    \endgroup\activatedigits%
}

\def\@stringdigits+1{%
    \begingroup
        \lccode`\~=`+1\relax
    \lowercase{\endgroup\def~}{\string+1}
}
\def\stringdigits{\let\do\@stringdigits \dodigits}

\activatedigits

\gameinput{%
    #N Gosper glider gun
    #C This was the first gun discovered.
    #C As its name suggests, it was discovered by Bill Gosper.
    x = 36, y = 9, rule = B3/S23

    %% Cryptic error messages, it should work (at least I think) in theory but doesn't.
    %% Probably some tokenization issue (?)
    %% e-TeX's \scantokens may be of use here, but I do not know its syntax well enough.

    %\l@input@body@parse@setup
    %\immediate\write16{EOL has catcode: \the\catcode`\^^M{} and definition \meaning^^M.}
    24bo$22bobo$12b2o6b2o12b2o$11bo3bo4b2o12b2o$2o8bo5bo3b2o$2o8bo3bob2o4b
    obo$10bo5bo7bo$11bo3bo$12b2o!
}

\l@input@body@parse@setup

    {\tt24bo$22bobo$12b2o6b2o12b2o$11bo3bo4b2o12b2o$2o8bo5bo3b2o$2o8bo3bob2o4b
    obo$10bo5bo7bo$11bo3bo$12b2o}

\disabledigits

%\l@attrib@desc
%\l@attrib@name
%\l@attrib@desc
%\l@attrib@name

\catcode`\#=6 \catcode`\$=3 \catcode`\+=12\relax

\vfill\eject
